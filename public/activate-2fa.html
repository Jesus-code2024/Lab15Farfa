<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Activar 2FA</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="card">
    <h2>Activar Autenticación 2FA</h2>

    <p>Haz clic para generar tu código QR:</p>

    <button onclick="activar2FA()">Generar código QR</button>

    <div id="qr-container" style="display:none; margin: 20px 0;">
        <p>Escanea este código con Google Authenticator:</p>
        <img id="qr" width="250" style="border: 2px solid #ddd; padding: 10px; background: white;" />
    </div>

    <p><a href="verify-2fa.html">Ya escaneé el código → Verificar</a></p>
</div>

<script src="app.js"></script>

<script>
async function activar2FA() {
    const tempToken = localStorage.getItem("tempToken");

    if (!tempToken) {
        alert("No hay sesión activa. Por favor inicia sesión primero.");
        window.location.href = "/login.html";
        return;
    }

    try {
        const res = await fetch("/2fa/setup", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ tempToken })
        });

        const data = await res.json();
        console.log(data);

        if (data.qr) {
            document.getElementById("qr").src = data.qr;
            document.getElementById("qr-container").style.display = "block";
            alert("Código generado. Escanéalo con Google Authenticator.");
        } else {
            alert("Error generando el QR: " + (data.error || "Desconocido"));
        }
    } catch (error) {
        console.error(error);
        alert("Error de conexión al servidor");
    }
}
</script>
</body>
</html>
